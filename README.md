# EMU4004

4040実CPUを動作させてみました。  
4001(ROM), 4002(RAM), 4289(メモリコントローラ）および  
バンクメモリ機能をPICでエミュレートしました。  

Ryo Mukaiさん作の(ブレッドボード版)4004SBC機能互換を目指し  
電卓, VTL, 8080エミュレータが動作しています。  

![外観](https://github.com/Gazelle8087/EMU4004/blob/main/pics/EMU4004_ASSY.jpg)

Ryo Mukaiさん作 実機に関しては以下リポジトリご参照ください。  
https://github.com/ryomuk/VTL4004

## ビルド環境
PIC ファームウエア  
IDE: MPLAB X v6.25  
Compiler: MPLAB XC8 v3.0  

ターゲットマイコン：PIC18F47Q84/83  
(バンクメモリ容量4KB確保するため Q43ではRAM容量が不足します)

4004 アセンブラ
Macro assembler  AS V1.42 Beta [Bld 290]  

## アセンブラソース

4004アセンブラソースは以下リポジトリから流用させていただきました。  
ソフトウエアシリアル、バンクメモリ含めソース変更無しで動作させることができました。  

電卓  
https://github.com/ryomuk/test4004/tree/main/src/calc

VTL  
https://github.com/ryomuk/VTL4004/tree/main/src/ver1.0

8080エミュレータ  
https://github.com/ryomuk/emu8080on4004/tree/main/prototype/src/emu.4k


## プリント基板

EMU4004_100.zipは本製作に使った基板の製造データです。  
要修正項目(後述)は反映されていません。  

![表](https://github.com/Gazelle8087/EMU4004/blob/main/pics/EMU4004_PCB_F.jpg)
![裏](https://github.com/Gazelle8087/EMU4004/blob/main/pics/EMU4004_PCB_B.jpg)

## 回路の説明

(回路図は修正分加筆し追ってアップします)  

【電源】  
4004, 4040は15V電源が必要ですが、本製作では  
Vss=5.2V Vdd=-9.4V(いずれも実測) にて14.6Vを生成しました。(規格下限は14.25V)  
なお、Vddは MAU-103(5V→9V 絶縁型DCDCコンバータ)を極性反転で使い  
負荷時の出力電圧が 実測で-9.4Vであることを確認しました。  

【クロックドライバ】  
4004/4040のクロック入力規格を満たすため DS0026 を使いました。  

【VIL】  
規格上4004/4040を駆動するにはVILとして Vss-5.5Vが上限となっており  
PICのL出力(≒0V)では(負電圧が)足りないのですが  
実機で確認したところ、動作マージン内で駆動できているようです。  

【VOL】  
4004/4040のL出力は実測にて 無負荷時 約-8V  
(電流制限抵抗4.7kΩ通した)負荷時 約-5Vでしたので  
PICとの接続は 4.7kΩの電流制限抵抗+内蔵クランプダイオードで問題無しと判断しました。  

しかし実際に接続してみると、オシロスコープで見る限り正常にクランプできているのですが、  
(おそらくオシロで見えない短時間の)負電圧によって内蔵デバイスが誤作動しているように  
思われクロックが断続的に停止するトラブルがありました。  
試行錯誤した結果、RA3ポートを 4.7kΩでプルアップして L入力時の電圧を  
約+0.3V程度にすれば問題なくなりました。  
(理屈や理由ご存じの方お見えでしたら教えてください)  

## Pch オープンドレイン出力について

4004→4040にて機能拡張した際に、いくつかの端子が追加されました。  
そのうち CY INT-ACK STP-ACK は オープンドレインとなっていて  
データシートには [VDDへのプルダウン抵抗が必要]との記述があります。  
基板設計時にはそのことを正確に理解しておらず、  
Nch オープンドレインと同じように +5Vから抵抗を繋いでおけば  
吸い込んでくれるものと思い違いをしていました。  

その部分のプルダウン抵抗と上述のRA3プルアップ抵抗は基板に  
実装されていませんので追加する必要があります。  
(その部分加筆した回路図を追ってアップします)

## PIC側ファームウエアについて

4004/4040はウエイト機能がないこと、4001/4002/4289がそれぞれ独自に  
命令をデコードし動作している部分をエミュレートする必要があり、  
特に忙しいA3～X1ステートに関しては wait loop でクロックと同期させる  
時間的余裕がありませんでした。  

そのため A2ステートの最後のφ2立ち上がりで同期した以降は  
M1-M2-X1ステート開始までPICのクロック数を数えながら  
NOPで調整してタイミングを合わせました。  

本製作ではシリアルポートを2個実装し  
左側をPIC UARTポート(後述のランニングモニタ)  
右側を4004/4040のソフトウエアシリアルポートとしています。  

## ライセンス

PICのファームウエアと基板設計データはMITとします。

## 4004実機動作事例

Ryo Mukaiさんが 4004入手から一連の作例までをブログにまとめてお見えです。  
https://note.com/ryomuk/m/m2f55e2a1f586  

読み応え十分であり、本製作にあたってのヒントをたくさんいただきました。  
この場をお借りしてお礼申し上げます。  

## 実機との非互換性について  

本製作ではPICのGPIO数制約やソフトウエアエミュレーションの  
簡略化のためいくつかの非互換性があります。

【RAM出力ポート ヘッダとLED表示】  
物理ポートが無くLEDも未実装です。  

【RAM出力ポート チップセレクト】  
実機ではCM-RAMラインによってIOポートバンクセレクトしますが、  
本製作では、CM-RAM出力はデコードせず、SRC上位2ビットのみでデコードします。  
一連のソフトでは常にRAMバンク0選択されているので動作に影響はありませんでした。  

【ランニングモニタ】  
実機ではポート出力がLEDでリアルタイム表示されるのに対し、  
本製作では、割込み待ち時間を使ってPIC側コンソールに間引きして  
(1回/約10000サイクル)表示します。  

モニタではエミュレーションの副産物である各種値を左から  
PC(3桁) 命令コード(2桁) アキュームレータ(4040)またはOPA(4004) (1桁)  
CM-RAM+SRC (3桁) PORT3～0出力値 (4桁) を連続して表示します。  

ソフトウエアシリアル出力例  
![ソフトシリアルコンソール](https://github.com/Gazelle8087/EMU4004/blob/main/pics/EMU4004_mandel.jpg)

ランニングモニタ表示  
![ランニングモニタ](https://github.com/Gazelle8087/EMU4004/blob/main/pics/EMU4004_running_monitor.jpg)


## EMUZ80について

電脳伝説さん制作のZ80をPICで駆動するSBCで本製作の発想のベースとなってます。
https://vintagechips.wordpress.com/2022/03/05/emuz80_reference/

## 変更履歴
2025/09/13 Rev. 1.00 初回公開  
2025/09/14 Rev. 1.01 CM-RAM 処理間違い修正  
2025/09/16 Rev. 1.02 BBS(4040拡張命令)でSRCを受け取るようにした  
